datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

generator client {
  provider = "prisma-client"
  output = "./generated"
  engineType = "client"
  previewFeatures = ["postgresqlExtensions"]
}

generator zod {
  provider = "prisma-zod-generator"
  output   = "./zod"
  config   = "./zod-generator.config.json"
}

model User {
  id                 String       @id @default(cuid())
  name               String
  email              String
  emailVerified      Boolean
  image              String?
  createdAt          DateTime
  updatedAt          DateTime
  username           String?
  role               String?
  banned             Boolean?
  banReason          String?
  banExpires         DateTime?
  onboardingComplete Boolean      @default(false)
  paymentsCustomerId String?
  locale             String?
  displayUsername    String?
  twoFactorEnabled   Boolean?
  sessions           Session[]
  accounts           Account[]
  passkeys           Passkey[]
  invitations        Invitation[]
  purchases          Purchase[]
  members            Member[]
  twofactors         TwoFactor[]
  aiChats            AiChat[]
  marketingContent   MarketingContent[]
  marketingAdCampaigns MarketingAdCampaign[]
  marketingLogs      MarketingLog[]

  @@unique([email])
  @@unique([username])
  @@map("user")
}

model Session {
  id        String   @id @default(cuid())
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  impersonatedBy String?

  activeOrganizationId String?

  token     String
  createdAt DateTime
  updatedAt DateTime

  @@unique([token])
  @@map("session")
}

model Account {
  id           String    @id @default(cuid())
  accountId    String
  providerId   String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String?   @db.Text
  refreshToken String?   @db.Text
  idToken      String?   @db.Text
  expiresAt    DateTime?
  password     String?

  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String   @db.Text
  expiresAt  DateTime

  createdAt DateTime?
  updatedAt DateTime?

  @@map("verification")
}

model Passkey {
  id           String    @id @default(cuid())
  name         String?
  publicKey    String
  userId       String
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  credentialID String
  counter      Int
  deviceType   String
  backedUp     Boolean
  transports   String?
  aaguid       String?
  createdAt    DateTime?

  @@map("passkey")
}

model TwoFactor {
  id          String @id @default(cuid())
  secret      String
  backupCodes String
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("twoFactor")
}

model Organization {
  id                 String       @id @default(cuid())
  name               String
  slug               String?
  logo               String?
  createdAt          DateTime
  metadata           String?
  paymentsCustomerId String?
  members            Member[]
  invitations        Invitation[]
  purchases          Purchase[]
  aiChats            AiChat[]
  marketingContent   MarketingContent[]
  marketingSeo       MarketingSeo[]
  marketingAdCampaigns MarketingAdCampaign[]
  marketingPublications MarketingPublication[]
  socialMediaAccounts SocialMediaAccount[]
  marketingKpis      MarketingKpi[]
  marketingLogs      MarketingLog[]
  marketingLearnings MarketingLearning[]
  marketingConfig    MarketingConfig?
  marketingUsage     MarketingUsage[]
  marketingOnboarding MarketingOnboarding?
  marketingMemories  MarketingMemory[]
  marketingDecisions MarketingDecision[]
  viralBlueprints    ViralBlueprint[]
  marketingJobs      MarketingJob[]
  marketingGuards    MarketingGuard[]
  saasProducts       SaasProduct[]

  @@unique([slug])
  @@map("organization")
}

model Member {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  role           String
  createdAt      DateTime

  @@unique([organizationId, userId])
  @@map("member")
}

model Invitation {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  role           String?
  status         String
  expiresAt      DateTime
  inviterId      String
  user           User         @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@map("invitation")
}

enum PurchaseType {
  SUBSCRIPTION
  ONE_TIME
}

model Purchase {
  id             String        @id @default(cuid())
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String?
  type           PurchaseType
  customerId     String
  subscriptionId String?       @unique
  productId      String
  status         String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([subscriptionId])
  @@map("purchase")
}

model AiChat {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  title          String?
  /// [ChatMessages]
  messages       Json          @default("[]")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("ai_chat")
}

// MarketingOS - Modo Dios Models

enum MarketingContentType {
  EMAIL
  POST
  REEL
  BLOG
}

enum MarketingContentStatus {
  DRAFT
  GENERATED
  OPTIMIZED
  PUBLISHED
  ARCHIVED
}

model MarketingContent {
  id             String                @id @default(cuid())
  organizationId String
  organization   Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  type           MarketingContentType
  status         MarketingContentStatus @default(DRAFT)
  title          String?
  content        String                @db.Text
  metadata       Json?                 // SEO metadata, tags, etc.
  aiPrompt       String?               @db.Text
  aiModel        String?
  optimizationData Json?               // Datos de optimización SEO/ADS
  publishedAt    DateTime?
  productId      String?
  product        SaasProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  publications   MarketingPublication[]

  @@index([organizationId])
  @@index([userId])
  @@index([type])
  @@index([status])
  @@map("marketing_content")
}

enum SeoAnalysisStatus {
  PENDING
  ANALYZING
  COMPLETED
  FAILED
}

model MarketingSeo {
  id             String            @id @default(cuid())
  organizationId String
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  url            String
  status         SeoAnalysisStatus @default(PENDING)
  score          Int?              // Score SEO 0-100
  analysis       Json?             // Análisis completo (keywords, meta tags, etc.)
  recommendations Json?            // Recomendaciones de optimización
  optimizedContent String?         @db.Text
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([organizationId])
  @@index([url])
  @@map("marketing_seo")
}

enum AdCampaignStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

enum AdPlatform {
  GOOGLE_ADS
  FACEBOOK_ADS
  INSTAGRAM_ADS
  LINKEDIN_ADS
  TWITTER_ADS
}

model MarketingAdCampaign {
  id             String            @id @default(cuid())
  organizationId String
  organization   Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  name           String
  platform       AdPlatform
  status         AdCampaignStatus  @default(DRAFT)
  budget         Float?
  targetAudience Json?             // Audiencia objetivo
  keywords       Json?             // Keywords para la campaña
  adCopy         String            @db.Text
  aiGenerated    Boolean           @default(false)
  externalId     String?           // ID en la plataforma externa
  performance    MarketingAdPerformance[]
  productId     String?
  product       SaasProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@index([platform])
  @@map("marketing_ad_campaign")
}

model MarketingAdPerformance {
  id             String              @id @default(cuid())
  campaignId     String
  campaign       MarketingAdCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  impressions   Int                 @default(0)
  clicks         Int                 @default(0)
  conversions    Int                 @default(0)
  spend          Float               @default(0)
  revenue        Float               @default(0)
  ctr            Float?              // Click-through rate
  cpc            Float?              // Cost per click
  cpa            Float?              // Cost per acquisition
  roas           Float?              // Return on ad spend
  date           DateTime
  metadata       Json?               // Datos adicionales de la plataforma
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([campaignId])
  @@index([date])
  @@map("marketing_ad_performance")
}

enum SocialMediaPlatform {
  FACEBOOK
  INSTAGRAM
  TWITTER
  LINKEDIN
  TIKTOK
  YOUTUBE
}

enum PublicationStatus {
  SCHEDULED
  PUBLISHING
  PUBLISHED
  FAILED
}

model MarketingPublication {
  id             String              @id @default(cuid())
  organizationId String
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contentId      String?
  content        MarketingContent?   @relation(fields: [contentId], references: [id], onDelete: SetNull)
  platform       SocialMediaPlatform
  status         PublicationStatus   @default(SCHEDULED)
  scheduledAt    DateTime?
  publishedAt    DateTime?
  externalId     String?             // ID en la plataforma externa
  url            String?
  error          String?             @db.Text
  metadata       Json?               // Datos adicionales de la publicación
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([organizationId])
  @@index([contentId])
  @@index([platform])
  @@index([status])
  @@index([scheduledAt])
  @@map("marketing_publication")
}

model SocialMediaAccount {
  id             String              @id @default(cuid())
  organizationId String
  organization   Organization        @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platform       SocialMediaPlatform
  accountName    String
  accountId      String              // ID en la plataforma
  accessToken    String              @db.Text
  refreshToken   String?             @db.Text
  expiresAt      DateTime?
  isActive       Boolean             @default(true)
  metadata       Json?               // Datos adicionales de la cuenta
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@unique([organizationId, platform, accountId])
  @@index([organizationId])
  @@index([platform])
  @@map("social_media_account")
}

model MarketingKpi {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  date           DateTime
  metric         String        // Nombre del KPI (e.g., "total_content", "seo_score", "ad_spend")
  value          Float
  metadata       Json?         // Datos adicionales del KPI
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId])
  @@index([date])
  @@index([metric])
  @@map("marketing_kpi")
}

enum LogLevel {
  INFO
  WARNING
  ERROR
  SUCCESS
}

model MarketingLog {
  id             String        @id @default(cuid())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  level          LogLevel
  category       String        // "content", "seo", "ads", "publication", "automation"
  message        String        @db.Text
  metadata       Json?         // Datos adicionales del log
  createdAt      DateTime      @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([level])
  @@index([category])
  @@index([createdAt])
  @@map("marketing_log")
}

model MarketingLearning {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  eventType      String        // Tipo de evento aprendido
  eventData      Json          // Datos del evento
  insights       Json?         // Insights generados
  applied        Boolean       @default(false)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId])
  @@index([eventType])
  @@index([applied])
  @@map("marketing_learning")
}

// MarketingOS - Configuración y Límites

enum MarketingPlanType {
  GOD_MODE
  CLIENT_PREMIUM
  TRIAL
}

model MarketingConfig {
  id             String          @id @default(cuid())
  organizationId String          @unique
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planType       MarketingPlanType @default(TRIAL)
  autoPilotEnabled Boolean        @default(false)
  autoPilotFrequency String?      // "6h", "12h", "30m" (solo para GOD_MODE)
  aiModel        String?         // "gpt-4o", "gpt-4o-mini", "claude-3-5-sonnet"
  optimizationFrequency String?   // "30m", "1h", "6h" (solo para GOD_MODE)
  reportFrequency String?       // "daily", "weekly" (daily solo para GOD_MODE)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@map("marketing_config")
}

model MarketingUsage {
  id             String        @id @default(cuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  month          Int           // 1-12
  year           Int           // 2024, 2025, etc.
  contentGenerated Int         @default(0)
  seoAnalyses    Int           @default(0)
  adCampaigns    Int           @default(0)
  publications   Int           @default(0)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@unique([organizationId, month, year])
  @@index([organizationId])
  @@map("marketing_usage")
}

enum OnboardingStep {
  BUSINESS_INFO
  SOCIAL_MEDIA
  OBJECTIVES
  TONE_STYLE
  AUTOPILOT
  COMPLETED
}

model MarketingOnboarding {
  id             String          @id @default(cuid())
  organizationId String          @unique
  organization   Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  currentStep    OnboardingStep  @default(BUSINESS_INFO)
  completed      Boolean         @default(false)
  businessInfo   Json?           // Información del negocio
  socialMedia    Json?           // Redes sociales configuradas
  objectives     Json?           // Objetivos de marketing
  toneStyle      Json?           // Tono y estilo preferido
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@map("marketing_onboarding")
}

// ============================================
// MARKETINGOS - SISTEMA NERVIOSO CENTRAL
// ============================================

model MarketingMemory {
  id             String   @id @default(cuid())
  type           String   // "business_dna", "learning", "trend", "prompt_template"
  content        String   @db.Text
  embedding      Json?    // Almacenaremos el vector como JSON
  metadata       Json?
  importance     Int      @default(5) // 1-10
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([type])
  @@index([organizationId])
  @@index([importance])
  @@map("marketing_memory")
}

model MarketingDecision {
  id             String   @id @default(cuid())
  agentType      String   // "orchestrator", "content", "ads", "sales", "visual"
  decision       String   @db.Text
  reasoning      String   @db.Text
  context        Json
  outcome        Json?
  success        Boolean?
  executedAt     DateTime?
  createdAt      DateTime @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([agentType])
  @@index([organizationId])
  @@index([createdAt])
  @@map("marketing_decision")
}

model ViralBlueprint {
  id          String   @id @default(cuid())
  platform    String   // "instagram", "tiktok", "twitter", "linkedin"
  hook        String   @db.Text
  structure   String   @db.Text
  cta         String
  metrics     Json     // { views: 1000000, engagement: 5.2, saves: 45000 }
  extractedAt DateTime @default(now())
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([platform])
  @@index([extractedAt])
  @@map("viral_blueprint")
}

model MarketingJob {
  id             String   @id @default(cuid())
  name           String
  type           String   // "content_generation", "campaign_optimization", "lead_nurturing"
  status         String   // "pending", "running", "completed", "failed"
  progress       Int      @default(0) // 0-100
  result         Json?
  error          String?  @db.Text
  startedAt      DateTime?
  completedAt    DateTime?
  createdAt      DateTime @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([organizationId])
  @@index([createdAt])
  @@map("marketing_job")
}

model MarketingGuard {
  id             String   @id @default(cuid())
  guardType      String   // "financial", "reputation", "legal"
  metric         String   // "cpa", "sentiment", "claim_validity"
  threshold      Float
  currentValue   Float
  status         String   // "ok", "warning", "critical"
  triggered      Boolean  @default(false)
  action         String?  @db.Text
  lastCheck      DateTime @default(now())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([guardType])
  @@index([status])
  @@index([organizationId])
  @@map("marketing_guard")
}

// ============================================
// INTEGRACIÓN CON AUTO-SAAS BUILDER
// ============================================

model SaasProduct {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  description       String   @db.Text
  targetAudience    String   @db.Text
  features          Json     // Array de features
  pricing           Json     // Pricing tiers
  usp               String   @db.Text // Unique Selling Proposition
  status            String   @default("pending") // pending, active, paused
  
  // Metadata del Auto-SaaS Builder
  builderProjectId  String   @unique
  builderStatus     String   // building, deployed, live
  deploymentUrl     String?
  repositoryUrl     String?
  
  // Marketing automation
  marketingEnabled  Boolean  @default(true)
  marketingMemoryId String?  // ID de memoria creada
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  // Relaciones
  marketingCampaigns MarketingAdCampaign[]
  content            MarketingContent[]
  inbox              AutoSaasInbox[]
  outbox             AutoSaasOutbox[]
  
  @@index([slug])
  @@index([builderProjectId])
  @@index([organizationId])
  @@map("saas_product")
}

model AutoSaasInbox {
  id             String   @id @default(cuid())
  type           String   // "feature_request", "market_opportunity", "user_feedback"
  priority       Int      @default(5) // 1-10
  title          String
  description    String   @db.Text
  data           Json     // Datos adicionales
  
  // Estado
  status         String   @default("pending") // pending, processing, completed, rejected
  processedAt    DateTime?
  result         Json?
  
  createdAt      DateTime @default(now())
  productId      String?
  product        SaasProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([priority])
  @@index([productId])
  @@map("auto_saas_inbox")
}

model AutoSaasOutbox {
  id             String   @id @default(cuid())
  type           String   // "new_product", "product_update", "deployment"
  payload        Json
  status         String   @default("pending") // pending, processing, completed, failed
  processedAt    DateTime?
  error          String?  @db.Text
  
  createdAt      DateTime @default(now())
  productId      String?
  product        SaasProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([productId])
  @@map("auto_saas_outbox")
}